{% extends 'whats_on_dot_com/events_base.html' %}
{% load staticfiles %}
{% load whats_on_template_tags %}

{% block title_block %}
    What's On - Map
{% endblock %}

{% block toggle_block %}
<ul class="nav nav-tabs justify-content-end">
    <li class="nav-item">
        <a class="nav-link" href="{% url 'events' %}">List</a>
    </li>
    <li class="nav-item">
        <a class="nav-link active" href="{% url 'events_map' %}">Map</a>
    </li>
</ul>
{% endblock %}
 
{% block events_block %}

    <!-- Insert map here -->
    <div><select id="locationSelect" style="width: 10%; visibility: hidden"></select></div>
    <div id="map" style="width: 100%; height: 53%"></div>
    <script>
	// Javascript relies on django and breaks when moved to a seperate file hence inline
      var map;
      var markers = [];
      var infoWindow;
      var locationSelect;
	  

        function initMap() {
		  var locations = [
			//locations is populated by the function in view which has parameters defined by the filter bar on the webpage.
			{% for Event in events %}

			//change to a clickable link that takes to event page rather than just text name of event
			['<p>{{ Event.name }} </p>', '<p>{{ Event.description }} </p>', {{ Event.latitude }}, {{ Event.longitude }}],
			{% endfor%}
			];	
			console.log("Length of map_points variable in template", {{ tag_test|length }});

          var map_centre = {lat: {{focus_lat}}, lng: {{focus_lng}}};
          map = new google.maps.Map(document.getElementById('map'), {
            center: map_centre,
            zoom: 10,
            mapTypeId: 'roadmap',
            mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DROPDOWN_MENU}
          });
          infoWindow = new google.maps.InfoWindow();

          //searchButton = document.getElementById("searchButton").onclick = searchLocations;

          locationSelect = document.getElementById("locationSelect");
          locationSelect.onchange = function() {
            var markerNum = locationSelect.options[locationSelect.selectedIndex].value;
            if (markerNum != "none"){
              google.maps.event.trigger(markers[markerNum], 'click');
            }
          };
		  
		  var infowindow = new google.maps.InfoWindow();

    var marker, i;


    for (i = 0; i < locations.length; i++) {  
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(locations[i][2], locations[i][3]),
        map: map
      });

      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          infowindow.setContent(locations[i][0] + locations[i][1]);
          infowindow.open(map, marker);
        }
      })(marker, i));
    }
        }

	   
  </script>
  <!-- Think that's all from working maps page -->
  <!-- Need to add a script call at the bottom of body-->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDGS0bM93w4YN6uXAWGEoU-H_RwlnfbRk8&callback=initMap">
    </script>
{% endblock %}